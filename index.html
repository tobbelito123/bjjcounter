<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BJJ Submissions Counter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#0ea5e9" />
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="canonical" href="https://www.bjjcounter.com/" />
  <link rel="apple-touch-icon" href="/icons/icon-192.png" />

  <!-- If not a mobile device, bounce to desktop page -->
  <script>
    if (!/Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
      window.location.href = "desktop.html";
    }
  </script>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      -webkit-font-smoothing: antialiased;
      color: var(--fg);
      background: var(--bg);
      -webkit-tap-highlight-color: transparent;
    }
    [hidden] { display: none !important; }

    :root {
      --bg: #0b1020;
      --card: #121830;
      --card-2: #0f1428;
      --fg: #eaf1ff;
      --muted: #b7c4e1;
      --primary: #0ea5e9;
      --primary-2: #22d3ee;
      --ring: rgba(34, 211, 238, 0.35);
      --shadow: 0 10px 30px rgba(2, 6, 23, 0.4);
      --ok: #10b981;
      --warn: #f59e0b;
      --danger: #ef4444;

      --white: #ffffff;
      --blue: #1e40af;
      --purple: #6d28d9;
      --brown: #7c2d12;
      --black: #0b0b0b;
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f6f8ff;
        --card: #ffffff;
        --card-2: #f2f5ff;
        --fg: #0b1020;
        --muted: #475569;
        --shadow: 0 8px 24px rgba(2, 6, 23, 0.08);
      }
    }

    .wrap {
      max-width: 720px;
      margin: 0 auto;
      min-height: 100%;
      display: grid;
      grid-template-rows: auto auto 1fr;
      padding: 16px clamp(12px, 4vw, 20px) calc(16px + env(safe-area-inset-bottom));
      gap: 14px;
    }
    .submission { touch-action: pan-y; }
    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 12px;
      background: linear-gradient(180deg, rgba(34,211,238,0.06), transparent);
      border-radius: 16px;
    }
    .title { font-weight: 800; letter-spacing: 0.3px; font-size: 20px; display: flex; align-items: center; gap: 10px; }
    .title .dot {
      width: 10px; height: 10px; border-radius: 50%;
      background: radial-gradient(40% 40% at 30% 30%, var(--primary-2), var(--primary));
      box-shadow: 0 0 18px var(--ring);
    }
    .actions { display: flex; gap: 8px; align-items: center; }
    .ghost {
      background: transparent; border: 1px solid rgba(148,163,184,0.25);
      color: var(--muted); padding: 8px 10px; border-radius: 10px; font-size: 13px;
    }

    /* Install banner */
    .install-banner {
      display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 10px;
      padding: 10px 12px; border-radius: 14px; background: var(--card-2);
      border: 1px solid rgba(148,163,184,0.15); box-shadow: var(--shadow); font-size: 14px;
    }
    .install-banner strong { font-weight: 800; }
    .install-actions { display: flex; gap: 8px; }
    .install-btn, .dismiss-btn { appearance: none; border: 0; cursor: pointer; padding: 10px 12px; border-radius: 10px; font-weight: 700; }
    .install-btn { background: linear-gradient(180deg, rgba(34,211,238,0.12), rgba(14,165,233,0.18)); box-shadow: inset 0 0 0 1px rgba(14,165,233,0.35); color: var(--fg); }
    .dismiss-btn { background: transparent; border: 1px solid rgba(148,163,184,0.25); color: var(--muted); }

    .tabs {
      display: grid; grid-template-columns: 1fr 1fr; background: var(--card-2);
      border-radius: 14px; padding: 6px; box-shadow: var(--shadow);
      border: 1px solid rgba(148,163,184,0.15);
    }
    .tab {
      appearance: none; border: 0; background: transparent; color: var(--muted);
      padding: 16px 24px; border-radius: 12px; font-weight: 700; font-size: 18px; cursor: pointer; transition: all .2s;
    }
    .tab.active {
      color: var(--fg);
      background: linear-gradient(180deg, rgba(34,211,238,0.12), rgba(14,165,233,0.18));
      box-shadow: inset 0 0 0 1px rgba(14,165,233,0.35), 0 8px 20px rgba(2, 6, 23, 0.22);
      transform: scale(1.03);
    }

    main { display: grid; gap: 14px; }
    .grid { display: grid; gap: 12px; grid-template-columns: 1fr; }
    .card {
      background: var(--card); border-radius: 16px; padding: 16px; box-shadow: var(--shadow);
      border: 1px solid rgba(148,163,184,0.12);
    }
    .card .content { display: grid; grid-template-columns: 72px 1fr auto; align-items: center; gap: 12px; }
    .submission { position: relative; overflow: hidden; touch-action: pan-y; }
    .submission .swipe-bg { position: absolute; inset: 0; background: #ef4444; pointer-events: none; opacity: 0; transition: opacity .15s; }
    .submission .swipe-bg::after {
      content: "Delete"; position: absolute; right: 20px; top: 50%; transform: translateY(-50%);
      color: white; font-weight: 700; font-size: 14px; letter-spacing: 0.5px;
    }
    .submission.swiping .swipe-bg { opacity: 0.9; }
    .card .content { position: relative; transition: transform .15s ease, opacity .15s ease; will-change: transform; }

    .icon {
      width: 60px; height: 60px; border-radius: 16px; display: grid; place-items: center;
      background: radial-gradient(60% 60% at 35% 30%, rgba(34,211,238,0.4), rgba(14,165,233,0.15));
      border: 1px solid rgba(14,165,233,0.3);
    }
    .icon svg { width: 32px; height: 32px; opacity: 0.95; }
    .icon svg[data-belt] { width: 56px; height: 36px; }

    .card h3 { margin: 0 0 6px; font-size: 16px; letter-spacing: 0.2px; }
    .muted { color: var(--muted); font-size: 13px; }
    .count {
      font-weight: 800; font-size: 20px; letter-spacing: 0.3px; padding: 6px 10px; border-radius: 10px; min-width: 44px; text-align: center;
      background: linear-gradient(180deg, rgba(34,211,238,0.12), rgba(14,165,233,0.18)); border: 1px solid rgba(14,165,233,0.35);
    }

    .sheet-backdrop { position: fixed; inset: 0; background: rgba(2,6,23,0.4); opacity: 0; pointer-events: none; transition: opacity .2s; }
    .sheet {
      position: fixed; left: 0; right: 0; bottom: 0; transform: translateY(100%); transition: transform .3s;
      background: var(--card); border-top-left-radius: 16px; border-top-right-radius: 16px;
      box-shadow: 0 -10px 30px rgba(2,6,23,0.4); border-top: 1px solid rgba(148,163,184,0.18);
      padding: 14px 14px calc(14px + env(safe-area-inset-bottom));
    }
    .sheet.open { transform: translateY(0); }
    .sheet-backdrop.open { opacity: 1; pointer-events: auto; }
    .sheet h4 { margin: 4px 2px 10px; font-size: 15px; }

    .belts { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
    .belt {
      appearance: none; border: 0; border-radius: 12px; padding: 12px 8px;
      background: var(--card-2); color: var(--fg); font-weight: 700; font-size: 12px; letter-spacing: 0.2px;
      border: 1px solid rgba(148,163,184,0.16);
    }
    .belt .swatch { display: block; height: 16px; border-radius: 6px; margin-bottom: 8px; border: 1px solid rgba(0,0,0,0.2); }
    .belt[data-belt="white"] .swatch { background: var(--white); }
    .belt[data-belt="blue"] .swatch { background: var(--blue); }
    .belt[data-belt="purple"] .swatch { background: var(--purple); }
    .belt[data-belt="brown"] .swatch { background: var(--brown); }
    .belt[data-belt="black"] .swatch { background: var(--black); }

    .stat-card { padding: 16px; background: var(--card); border-radius: 16px; box-shadow: var(--shadow); border: 1px solid rgba(148,163,184,0.12); }
    .stat-head { display: flex; align-items: baseline; justify-content: space-between; gap: 12px; }
    .stat-head h3 { margin: 0; font-size: 15px; }
    .stat-head .total { font-weight: 800; }
    .bar { height: 12px; border-radius: 10px; display: grid; grid-auto-flow: column; overflow: hidden; margin-top: 10px; outline: 1px solid rgba(148,163,184,0.18); }
    .seg { height: 100%; }
    .seg.white { background: linear-gradient(180deg, #fff, #e5e7eb); }
    .seg.blue { background: linear-gradient(180deg, #3b82f6, #1e40af); }
    .seg.purple { background: linear-gradient(180deg, #a78bfa, #6d28d9); }
    .seg.brown { background: linear-gradient(180deg, #b45309, #7c2d12); }
    .seg.black { background: linear-gradient(180deg, #111827, #0b0b0b); }
    .legend { margin-top: 10px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; font-size: 12px; color: var(--muted); }
    .chip { display: flex; gap: 6px; align-items: center; }
    .dot { width: 10px; height: 10px; border-radius: 999px; }
    .dot.white { background: #fff; outline: 1px solid #cbd5e1; }
    .dot.blue { background: #1e40af; }
    .dot.purple { background: #6d28d9; }
    .dot.brown { background: #7c2d12; }
    .dot.black { background: #0b0b0b; outline: 1px solid #e5e7eb; }

    .foot { display: flex; gap: 10px; justify-content: space-between; align-items: center; margin-top: 2px; color: var(--muted); font-size: 12px; }
    .reset { background: transparent; border: 1px solid rgba(239,68,68,0.35); color: #fecaca; padding: 8px 10px; border-radius: 10px; font-size: 12px; }

    .toast {
      position: fixed; left: 50%; bottom: calc(18px + env(safe-area-inset-bottom));
      transform: translateX(-50%) translateY(16px);
      background: rgba(15, 23, 42, 0.9); color: #e2f7f6; padding: 10px 14px; border-radius: 12px;
      border: 1px solid rgba(34,211,238,0.35); box-shadow: var(--shadow);
      opacity: 0; transition: opacity .2s, transform .2s; font-size: 13px; pointer-events: none;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title"><span class="dot"></span> BJJ Submissions Counter</div>
      <div class="actions">
        <button class="ghost" id="addBtn" title="Add a submission">+ Add</button>
        <button class="ghost" id="sortBtn" title="Toggle sorting" aria-pressed="false"><> Sort</button>
        <button class="ghost" id="infoBtn" title="Info">‚ÑπÔ∏è Info</button>
      </div>
    </header>

    <!-- Install / A2HS banner -->
    <div id="installBanner" class="install-banner" hidden>
      <div id="installText">
        <strong>Install this app</strong><br/>
        Tap Install for 1-tap access and offline use.
      </div>
      <div class="install-actions">
        <button id="installDo" class="install-btn">Install</button>
        <button id="installDismiss" class="dismiss-btn">Dismiss</button>
      </div>
    </div>

    <nav class="tabs" role="tablist" aria-label="Views">
      <button class="tab active" data-tab="log" role="tab" aria-selected="true">Log</button>
      <button class="tab" data-tab="stats" role="tab" aria-selected="false">Stats</button>
    </nav>

    <main>
      <section id="view-log" class="grid" role="tabpanel" aria-labelledby="tab-log">
        <!-- Total (pinned at bottom, not a 'submission') -->
        <button class="card total" data-submission="__total" aria-label="Total of all moves">
          <div class="content">
            <div class="icon" aria-hidden="true"></div>
            <div>
              <h3>Total</h3>
              <div class="muted">All submissions combined</div>
            </div>
            <div class="count" id="count-__total">0</div>
          </div>
        </button>
        <div class="foot"></div>
      </section>

      <!-- Stats view -->
      <section id="view-stats" hidden role="tabpanel" aria-labelledby="tab-stats">
        <div id="statsList" class="grid"></div>
      </section>
    </main>
  </div>

  <!-- Bottom sheet for belt selection -->
  <div class="sheet-backdrop" id="sheetBackdrop"></div>
  <div class="sheet" id="beltSheet" aria-modal="true" role="dialog" aria-labelledby="sheetTitle">
    <h4 id="sheetTitle">Who did you hit it against?</h4>
    <div class="belts" role="group" aria-label="Opponent belt">
      <button class="belt" data-belt="white"><span class="swatch"></span>White</button>
      <button class="belt" data-belt="blue"><span class="swatch"></span>Blue</button>
      <button class="belt" data-belt="purple"><span class="swatch"></span>Purple</button>
      <button class="belt" data-belt="brown"><span class="swatch"></span>Brown</button>
      <button class="belt" data-belt="black"><span class="swatch"></span>Black</button>
    </div>
    <div class="hint">Tap a belt to log 1 sub for the selected submission.</div>
  </div>

  <!-- Info Sheet -->
  <div class="sheet-backdrop" id="infoBackdrop"></div>
  <div class="sheet" id="infoSheet" aria-modal="true" role="dialog" aria-labelledby="infoTitle">
    <h4 id="infoTitle">BJJ Submissions Counter ‚Äì Info</h4>
    <p>This app stores your submissions per belt locally in your browser‚Äôs cache (localStorage). Data stays on this device and works offline. It‚Äôs not synced anywhere.</p>
    <p>You can also install it as an app: On Android, Chrome may suggest it automatically. On iPhone, open Safari‚Äôs Share menu ‚Üí ‚ÄúAdd to Home Screen.‚Äù</p>
    <p>You can export to JSON for backup, and import that JSON file to restore. Reset wipes all counts.</p>
    <p style="margin-top:12px;">
      Grateful for feedback! üí¨
      <a href="mailto:info@bjjcounter.com?subject=BJJ%20Submissions%20Counter%20Feedback" style="color: var(--primary-2); text-decoration: underline;">info@bjjcounter.com</a>
    </p>
    <p style="margin-top:12px; font-size:12px; color:var(--muted);">
      View our <a href="/privacy.html" style="color: var(--primary-2); text-decoration: underline;">Privacy Policy</a>.
    </p>

    <div style="margin-top:14px;display:flex;flex-direction:column;gap:8px;">
      <button class="reset" id="resetBtn">Reset all data</button>
      <button class="ghost" id="exportBtn">Export</button>
      <button class="ghost" id="importBtn">Import</button>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">Saved</div>

  <script>
    // ------- Storage & Data -------
  
// ------- Storage & Data -------
const KEY = "bjj-submissions-v1";

/* (NEW) Shared cache keys used to migrate local data from Safari ‚Üí PWA */
const MIGRATION_CACHE = "bjj-migrate-v1";
const MIGRATION_URL   = "/__bjj_migrate__";
/* (NEW) Cookie-based fallback (chunked) for one-time migration */
const MIG_COOKIE_PREFIX = "bjj_mig_";
const MIG_COOKIE_MAX = 8; // up to 8 chunks (~32KB total, safe margin)

function setCookie(name, value, days=180) {
  try {
    const exp = new Date(Date.now() + days*864e5).toUTCString();
    document.cookie = `${name}=${value}; expires=${exp}; path=/; SameSite=Lax`;
  } catch {}
}
function getCookie(name) {
  const safe = name.replace(/([.*+?^${}()|[\]\\])/g, '\\$1');
  const m = document.cookie.match(new RegExp('(?:^|; )' + safe + '=([^;]*)'));
  return m ? m[1] : null;
}
function delCookie(name) { setCookie(name, "", -1); }

function writeMigrationCookie(obj) {
  try {
    const raw = JSON.stringify(obj);
    const enc = encodeURIComponent(raw);
    const CHUNK = 3800; // stay below 4KB per cookie incl. name/attrs
    const parts = Math.ceil(enc.length / CHUNK);
    for (let i=0;i<MIG_COOKIE_MAX;i++) delCookie(MIG_COOKIE_PREFIX+i);
    if (parts > MIG_COOKIE_MAX) return; // too big, skip cookie fallback
    for (let i=0;i<parts;i++) {
      const slice = enc.slice(i*CHUNK, (i+1)*CHUNK);
      setCookie(MIG_COOKIE_PREFIX + i, slice);
    }
  } catch {}
}
function readMigrationCookie() {
  try {
    let buf = "";
    for (let i=0;i<MIG_COOKIE_MAX;i++) {
      const part = getCookie(MIG_COOKIE_PREFIX + i);
      if (!part) break;
      buf += part;
    }
    if (!buf) return null;
    const dec = decodeURIComponent(buf);
    return JSON.parse(dec);
  } catch { return null; }
}
function clearMigrationCookie() {
  for (let i=0;i<MIG_COOKIE_MAX;i++) delCookie(MIG_COOKIE_PREFIX + i);
}
    // Exact initial order you requested
    const SUBMISSIONS = [
      "armbar_from_mount",
      "americana_from_mount",
      "ezekiel_choke_from_mount",
      "triangle_from_mount",
      "crosscollar_choke_from_mount",
      "armtriangle_from_mount",
      "armbar_from_guard",
      "triangle_from_guard",
      "kimura_from_guard",
      "omoplata_from_guard",
      "cross_collar_choke_from_guard",
      "baseballchoke_from_guard",
      "americana_from_side",
      "papercut_choke_from_side",
      "baseballchoke_from_side",
      "kimura_from_northsouth",
      "scissorchoke_from_northsouth",
      "rear_naked_choke",
      "bow_and_arrow_choke",
      "armbar_from_back",
      "triangle_from_back",
      "straight_ankle_lock"
    ];

    const LABELS = {
      armbar_from_mount: "Armbar from mount",
      americana_from_mount: "Americana from mount",
      ezekiel_choke_from_mount: "Ezekiel choke from mount",
      triangle_from_mount: "Triangle from mount",
      crosscollar_choke_from_mount: "Crosscollar choke from mount",
      armtriangle_from_mount: "Armtriangle from mount",
      armbar_from_guard: "Armbar from guard",
      triangle_from_guard: "Triangle from guard",
      kimura_from_guard: "Kimura from guard",
      omoplata_from_guard: "Omoplata from guard",
      cross_collar_choke_from_guard: "Cross-collar choke from guard",
      baseballchoke_from_guard: "Baseballchoke from guard",
      americana_from_side: "Americana from side",
      papercut_choke_from_side: "Papercut choke from side",
      baseballchoke_from_side: "Baseballchoke from side",
      kimura_from_northsouth: "Kimura from northsouth",
      scissorchoke_from_northsouth: "Scissorchoke from northsouth",
      rear_naked_choke: "Rear naked choke",
      bow_and_arrow_choke: "Bow and arrow choke",
      armbar_from_back: "Armbar from back",
      triangle_from_back: "Triangle from back",
      straight_ankle_lock: "Straight ankle lock"
    };

    const BELTS = ["white","blue","purple","brown","black"];
    const BELT_TO_RANK = { white:0, blue:1, purple:2, brown:3, black:4 };
    const BELT_COLORS = ["#ffffff","#1e40af","#6d28d9","#7c2d12","#0b0b0b"];

    function defaultData() {
      const zero = { white:0, blue:0, purple:0, brown:0, black:0 };
      const meta = { currentRank: 0, lastUpgradeTotal: 0, maxOpponentRank: 0 };
      const obj = { submissions: {} };
      for (const key of SUBMISSIONS) {
        obj.submissions[key] = { ...zero, _meta: { ...meta } };
      }
      return obj;
    }

    function readData() {
      try {
        const raw = localStorage.getItem(KEY);
        if (!raw) return defaultData();
        const parsed = JSON.parse(raw);
        const base = defaultData();
        for (const s of SUBMISSIONS) {
          parsed.submissions ??= {};
          parsed.submissions[s] ??= { ...base.submissions[s] };
          for (const b of BELTS) parsed.submissions[s][b] ??= 0;
          const m = parsed.submissions[s]._meta ?? (parsed.submissions[s]._meta = { currentRank: 0, lastUpgradeTotal: 0, maxOpponentRank: 0 });
          m.currentRank = Math.max(0, Math.min(4, m.currentRank|0));
          m.lastUpgradeTotal = Math.max(0, m.lastUpgradeTotal|0);
          m.maxOpponentRank = Math.max(0, Math.min(4, m.maxOpponentRank|0));
        }
        return parsed;
      } catch { return defaultData(); }
    }

function writeData(data) {
  // Persist to localStorage (current context)
  localStorage.setItem(KEY, JSON.stringify(data));
  // Also mirror to Cache Storage so the installed app can import it
  saveMigrationMirror(data);
}

function saveMigrationMirror(data){
  try {
    // Cache Storage mirror (best path when iOS shares it)
    if ("caches" in window) {
      caches.open(MIGRATION_CACHE).then(cache => {
        const res = new Response(JSON.stringify(data), {
          headers: { "Content-Type": "application/json", "Cache-Control": "no-store" }
        });
        cache.put(MIGRATION_URL, res).catch(()=>{});
      }).catch(()=>{});
    }
  } catch {}
  // (NEW) Cookie fallback mirror (chunked)
  writeMigrationCookie(data);
}
    const $  = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    function vibrate(ms=12){ if (navigator.vibrate) try { navigator.vibrate(ms); } catch {} }
    function toast(msg){ const t=$("#toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),1200); }

    let DATA = readData();
    let pendingSubmission = null;

    /* (NEW) If localStorage is empty (typical on first launch of the PWA on iOS),
   try to pull a previously mirrored copy from Cache Storage and adopt it. */
(async function migrateFromCacheIfNeeded(){
  try {
    const hasLocal = !!localStorage.getItem(KEY);
    if (hasLocal) return; // Nothing to migrate

    
  let obj = null;

// Try Cache Storage first
try {
  if ("caches" in window) {
    const cache = await caches.open(MIGRATION_CACHE);
    const res   = await cache.match(MIGRATION_URL);
    if (res) obj = await res.json();
  }
} catch {}

// Fallback to cookie if cache failed/missing
if (!obj) {
  obj = readMigrationCookie();
  // Optional: if still null, we‚Äôll just exit below
}
if (!obj) return;
    if (obj && obj.submissions) {
     DATA = obj;
writeData(DATA);     // re-save (and re-mirror) in the new context

// Clean up migration artifacts so it can't re-import
try { if ("caches" in window) { const c = await caches.open(MIGRATION_CACHE); await c.delete(MIGRATION_URL); } } catch {}
clearMigrationCookie();

// NEW: show what we actually imported
const importedTotal = totalAllFrom(obj);

refreshCards();
if (!document.getElementById("view-stats").hasAttribute("hidden")) buildStats();
toast(`Imported your previous data (total: ${importedTotal})`);
vibrate(12); 
    }
  } catch {
    /* no-op */
  }
})();
    function totalFor(sub) {
      const o = DATA.submissions[sub];
      return BELTS.reduce((n,b) => n + (o[b]||0), 0);
    }
    function totalAll() {
      let sum = 0;
      for (const s of Object.keys(DATA.submissions)) {
        const v = DATA.submissions[s];
        sum += (v.white|0)+(v.blue|0)+(v.purple|0)+(v.brown|0)+(v.black|0);
      }
      return sum;
    }
    function totalAllFrom(obj){
  try{
    if (!obj || !obj.submissions) return 0;
    const belts = ["white","blue","purple","brown","black"];
    let n = 0;
    for (const k of Object.keys(obj.submissions)) {
      const v = obj.submissions[k] || {};
      for (const b of belts) n += (v[b] | 0);
    }
    return n;
  } catch { return 0; }
}
    // Belt rank for total: +1 rank every 100 moves, capped at black
    function totalRank() {
      return Math.min(4, Math.floor(totalAll() / 100));
    }

    function ensureMeta(sub) {
      const s = DATA.submissions[sub];
      s._meta ??= { currentRank: 0, lastUpgradeTotal: 0, maxOpponentRank: 0 };
      return s._meta;
    }

    function applyProgression(sub, opponentBelt) {
      const total = totalFor(sub);
      const meta = ensureMeta(sub);

      if (opponentBelt) {
        const oppRank = BELT_TO_RANK[opponentBelt];
        if (oppRank > meta.maxOpponentRank) meta.maxOpponentRank = oppRank;
        if (oppRank > meta.currentRank) {
          meta.currentRank = oppRank;
          meta.lastUpgradeTotal = total;
        }
      }
      const delta = total - meta.lastUpgradeTotal;
      const steps = Math.floor(delta / 50);
      if (steps > 0) {
        meta.currentRank = Math.min(4, meta.currentRank + steps);
        meta.lastUpgradeTotal += steps * 50;
      }
      writeData(DATA);
    }

    function beltSvgFromMeta(sub) {
      const total = totalFor(sub);
      const meta = ensureMeta(sub);
      const rank = meta.currentRank;
      const stripes = Math.min(4, Math.floor((total - meta.lastUpgradeTotal) / 10));
      let svg = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 40' preserveAspectRatio='xMidYMid meet' data-belt='1'>
        <rect x='0' y='6' width='120' height='28' fill='${BELT_COLORS[rank]}' stroke='black' stroke-width='2'/>
        <rect x='120' y='6' width='60' height='28' fill='black' stroke='black' stroke-width='2'/>`;
      const positions = [125,140,155,170];
      for (let i=0;i<stripes;i++) svg += `<rect x='${positions[i]}' y='8' width='6' height='24' fill='white'/>`;
      svg += `</svg>`;
      return svg;
    }

    function sortedSubmissions(){ return [...SUBMISSIONS]; }

    function sortNow(){
      const sorted=[...SUBMISSIONS].sort((a,b)=>totalFor(b)-totalFor(a));
      SUBMISSIONS.length=0; SUBMISSIONS.push(...sorted);
      refreshCards();
      if (!document.getElementById("view-stats").hasAttribute("hidden")) buildStats();
      toast("Sorted by total hits");
    }

    function refreshCards(){
      const grid = document.getElementById("view-log");
      const foot = grid.querySelector(".foot");
      const subs = sortedSubmissions();

      // Update and pin each technique card above the foot
      subs.forEach(s => {
        const el = document.getElementById("count-" + s);
        if (el) el.textContent = totalFor(s);

        const icon = grid.querySelector(`[data-submission="${s}"] .icon`);
        if (icon) icon.innerHTML = beltSvgFromMeta(s);

        const card = grid.querySelector(`[data-submission="${s}"]`);
        if (card) grid.insertBefore(card, foot);
      });

      // Update the Total block (count + belt color per 100 moves)
      const totalEl = document.getElementById("count-__total");
      if (totalEl) totalEl.textContent = totalAll();

      const totalIcon = document.querySelector('[data-submission="__total"] .icon');
      if (totalIcon) {
        const rank = totalRank();                // 0..4
        const color = BELT_COLORS[rank];
        totalIcon.innerHTML =
          `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 40' preserveAspectRatio='xMidYMid meet' data-belt='1'>
             <rect x='0'   y='6' width='120' height='28' fill='${color}' stroke='black' stroke-width='2'/>
             <rect x='120' y='6' width='60'  height='28' fill='black' stroke='black' stroke-width='2'/>
           </svg>`;
      }

      // üîí Always keep Total just above the foot
      const totalCard = grid.querySelector('[data-submission="__total"]');
      if (totalCard) grid.insertBefore(totalCard, foot);
    }

    function buildStats(){
      const list=$("#statsList"); list.innerHTML="";
      for (const s of sortedSubmissions()){
        const totals=DATA.submissions[s];
        const sum=totalFor(s);
        const frag=document.createElement("div"); frag.className="stat-card";
        const bar=document.createElement("div"); bar.className="bar";
        for (const b of BELTS){
          const seg=document.createElement("div");
          seg.className="seg "+b;
          seg.style.width=(sum?(totals[b]/sum*100):0)+"%";
          bar.appendChild(seg);
        }
        const legend=document.createElement("div"); legend.className="legend";
        for (const b of BELTS){
          const chip=document.createElement("div"); chip.className="chip";
          const pct=sum?Math.round((totals[b]/sum)*100):0;
          chip.innerHTML=`<span class="dot ${b}"></span>${b[0].toUpperCase()+b.slice(1)} ¬∑ ${sum?`${totals[b]} (${pct}%)`:"0 (0%)"}`;
          legend.appendChild(chip);
        }
        frag.innerHTML=`<div class="stat-head"><h3>${LABELS[s]}</h3><div class="total">${sum}</div></div>`;
        frag.appendChild(bar); frag.appendChild(legend); list.appendChild(frag);
      }
    }

    const sheet=$("#beltSheet"); const backdrop=$("#sheetBackdrop");
    function openSheet(sub){ pendingSubmission=sub; $("#sheetTitle").textContent=`Who did you hit ${LABELS[sub]} against?`; sheet.classList.add("open"); backdrop.classList.add("open"); }
    function closeSheet(){ sheet.classList.remove("open"); backdrop.classList.remove("open"); setTimeout(()=>{pendingSubmission=null;},150); }
    backdrop.addEventListener("click", closeSheet);

    function attachSafeTap(btn,key){
      const H=14,V=14;
      let startX=0,startY=0,moved=false;
      btn.addEventListener("touchstart",(e)=>{const t=e.touches[0]; startX=t.clientX; startY=t.clientY; moved=false;},{passive:true});
      btn.addEventListener("touchmove",(e)=>{const t=e.touches[0]; if(Math.abs(t.clientY-startY)>V||Math.abs(t.clientX-startX)>H){ moved=true; btn._gestureMoving=true; }},{passive:true});
      btn.addEventListener("touchend",()=>{ if(!moved && !btn._gestureMoving && !btn._swiping && !btn.classList.contains("swiping")){ btn._fromTouch=true; openSheet(key); vibrate(8); setTimeout(()=>{btn._fromTouch=false;},0);} setTimeout(()=>{btn._gestureMoving=false;},0); });
      btn.addEventListener("click",()=>{ if(btn._fromTouch) return; if(btn._swiping||btn._gestureMoving||btn.classList.contains("swiping")) return; openSheet(key); vibrate(8); });
    }

    function attachSwipeToDelete(cardEl,key){
      const content=cardEl.querySelector(".content");
      const CLICK_OPEN_SHEET_DELTA=10, DELETE_THRESHOLD=96;
      let startX=0,currentX=0,dragging=false,activated=false;
      function setX(dx){ content.style.transform=`translateX(${dx}px)`; content.style.opacity=`${1-Math.min(Math.abs(dx)/220,0.25)}`; }
      function reset(){ content.style.transform=""; content.style.opacity=""; cardEl.classList.remove("swiping"); activated=false; }
      function onStart(e){ const t=e.touches?e.touches[0]:e; startX=currentX=t.clientX; dragging=true; activated=false; cardEl._swiping=true; cardEl._gestureMoving=false; }
      function onMove(e){ if(!dragging) return; const t=e.touches?e.touches[0]:e; currentX=t.clientX; const dx=Math.min(0,currentX-startX); if(Math.abs(dx)>2) cardEl._gestureMoving=true; if(!activated && dx<=-12){ activated=true; cardEl.classList.add("swiping"); } if(activated) setX(dx); }
      function onEnd(){ if(!dragging) return; dragging=false; const dx=currentX-startX; cardEl._swiping=false; setTimeout(()=>{cardEl._gestureMoving=false;},0);
        if(Math.abs(dx)<CLICK_OPEN_SHEET_DELTA){ reset(); return; }
        if(dx<=-DELETE_THRESHOLD){
          const ok=confirm(`Delete "${LABELS[key]||key}"? This removes it and its counts.`);
          if(ok){ const i=SUBMISSIONS.indexOf(key); if(i>=0) SUBMISSIONS.splice(i,1); delete DATA.submissions[key]; writeData(DATA); cardEl.remove(); if(!$("#view-stats").hasAttribute("hidden")) buildStats(); toast(`Deleted ${LABELS[key]||key}`); vibrate(20); return; }
        }
        reset();
      }
      cardEl.addEventListener("touchstart",onStart,{passive:true});
      cardEl.addEventListener("touchmove",onMove,{passive:true});
      cardEl.addEventListener("touchend",onEnd);
      cardEl.addEventListener("touchcancel",onEnd);
    }

    // Hook up existing (future) submission cards
    $$(".submission").forEach(btn => {
      const key = btn.dataset.submission;
      if (key === "__total") return; // skip Total
      attachSwipeToDelete(btn, key);
      attachSafeTap(btn, key);
    });

    $$(".belt").forEach(b=>{
      b.addEventListener("click",()=>{
        const belt=b.dataset.belt;
        if (!pendingSubmission) return;
        DATA.submissions[pendingSubmission][belt]+=1;
        applyProgression(pendingSubmission,belt);
        saveMigrationMirror(DATA);
        refreshCards();
        if (!$("#view-stats").hasAttribute("hidden")) buildStats();
        toast(`+1 ${LABELS[pendingSubmission]} vs ${belt[0].toUpperCase()+belt.slice(1)} belt`);
        vibrate(12);
        closeSheet();
      });
    });

    const tabs=$$(".tab");
    tabs.forEach(t=>t.addEventListener("click",()=>{
      tabs.forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      const show=t.dataset.tab;
      if (show==="log"){ $("#view-log").hidden=false; $("#view-stats").hidden=true; }
      else { $("#view-log").hidden=true; $("#view-stats").hidden=false; buildStats(); }
    }));

    document.getElementById("resetBtn").addEventListener("click", () => {
      if (confirm("Reset all counts? This cannot be undone.")) {
        DATA = defaultData();
        writeData(DATA);
        refreshCards();
        if (!document.getElementById("view-stats").hasAttribute("hidden")) buildStats();
        toast("All data reset");
        vibrate(20);
      }
    });

    $("#exportBtn").addEventListener("click",()=>{
      const blob=new Blob([JSON.stringify(DATA,null,2)],{type:"application/json"});
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a"); a.href=url; a.download="bjj-submissions.json"; document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url),0);
    });

    $("#importBtn").addEventListener("click",()=>{
      const input=document.createElement("input"); input.type="file"; input.accept="application/json";
      input.onchange=()=>{ const file=input.files?.[0]; if(!file) return;
        const reader=new FileReader();
        reader.onload=()=>{ try{
          const obj=JSON.parse(String(reader.result));
          if(!obj?.submissions) throw new Error("Invalid file");
          DATA=obj; writeData(DATA); refreshCards(); if(!$("#view-stats").hasAttribute("hidden")) buildStats(); toast("Import successful"); vibrate(16);
        }catch{ alert("Could not import that file."); } };
        reader.readAsText(file);
      };
      input.click();
    });

    function slugify(label){ return label.toLowerCase().replace(/[^\w\s-]/g,"").trim().replace(/\s+/g,"_"); }
    function ensureZeroed(key){ const zero={white:0,blue:0,purple:0,brown:0,black:0}; if(!DATA.submissions[key]) DATA.submissions[key]={...zero, _meta:{currentRank:0,lastUpgradeTotal:0,maxOpponentRank:0}}; }

    function renderCard(key){
      if (document.getElementById("count-"+key)) return;
      const grid=document.querySelector("#view-log.grid");
      const beforeFoot=grid.querySelector(".foot");
      const card=document.createElement("button");
      card.className="card submission"; card.dataset.submission=key; card.setAttribute("aria-label","Log "+(LABELS[key]||key));
      card.innerHTML=`<div class="swipe-bg"></div>
        <div class="content">
          <div class="icon" aria-hidden="true"></div>
          <div><h3>${LABELS[key]||key}</h3><div class="muted">Tap to log vs belt</div></div>
          <div class="count" id="count-${key}">0</div>
        </div>`;
      grid.insertBefore(card,beforeFoot);
      const icon=card.querySelector(".icon"); if(icon) icon.innerHTML=beltSvgFromMeta(key);
      attachSwipeToDelete(card,key); attachSafeTap(card,key);
    }

    function addSubmissionFlow(){
      const name=(prompt("Submission name (e.g., Triangle):")||"").trim();
      if(!name) return;
      let key=slugify(name); if(!key) return alert("That name doesn‚Äôt produce a valid key.");
      let base=key,i=2; while(SUBMISSIONS.includes(key)) key=`${base}_${i++}`;
      SUBMISSIONS.push(key); LABELS[key]=name; ensureZeroed(key);
      writeData(DATA); renderCard(key); refreshCards(); if(!document.getElementById("view-stats").hasAttribute("hidden")) buildStats();
      toast(`Added "${name}"`); vibrate(12);
    }

    // Initial render
    SUBMISSIONS.forEach((key)=>{ if(!document.getElementById("count-"+key)){ ensureZeroed(key); renderCard(key);} });
    refreshCards();
    // (NEW) Warn if not on canonical host to avoid cross-origin installs
if (location.hostname !== "www.bjjcounter.com") {
  toast("Tip: install from www.bjjcounter.com to carry data into the app");
}
    document.getElementById("addBtn").addEventListener("click", addSubmissionFlow);
    document.getElementById("sortBtn").addEventListener("click", sortNow);
// (NEW) Make sure a migration mirror exists on first load in Safari
saveMigrationMirror(DATA);
    // Install / A2HS banner (no cookie/cache logic)
    (function () {
      const banner = document.getElementById("installBanner");
      const txt = document.getElementById("installText");
      const btnInstall = document.getElementById("installDo");
      const btnDismiss = document.getElementById("installDismiss");

      const isStandalone = matchMedia('(display-mode: standalone)').matches || navigator.standalone;
      if (isStandalone) return;

      const DISMISS_KEY = "install_hint_dismissed";
      if (localStorage.getItem(DISMISS_KEY) === "1") return;

      const isiOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
      let deferredPrompt = null;

      window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredPrompt = e;
        if (localStorage.getItem(DISMISS_KEY) !== "1") {
          txt.innerHTML = `<strong>Install this app</strong><br/>Tap <em>Install</em> for 1-tap access and offline use.`;
          banner.hidden = false;
        }
      });

      if (isiOS) {
        if (localStorage.getItem(DISMISS_KEY) !== "1") {
          txt.innerHTML = `<strong>Add to Home Screen</strong><br/>Tap the <span style="border:1px solid rgba(148,163,184,0.35); padding:0 6px; border-radius:6px;">Share</span> button ‚Üí <em>Add to Home Screen</em>.`;
          banner.hidden = false;
          btnInstall.style.display = "none";
        }
      }

      window.addEventListener("appinstalled", () => {
        localStorage.setItem(DISMISS_KEY, "1");
        banner.hidden = true;
      });

      btnDismiss?.addEventListener("click", () => {
        localStorage.setItem(DISMISS_KEY, "1");
        banner.hidden = true;
      });

      btnInstall?.addEventListener("click", async () => {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        try {
          const choice = await deferredPrompt.userChoice;
          if (choice.outcome === "accepted") {
            localStorage.setItem("install_hint_dismissed", "1");
            banner.hidden = true;
          }
        } finally {
          deferredPrompt = null;
        }
      });
    })();
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js', { scope: '/' }).catch(console.error);
      });
    }
  </script>
</body>
</html>
